
## Step-by-Step Guide

### 1. Create the Wallets

First, we'll create two wallets: one main wallet and one watch-only wallet.

```bash
# Create main wallet
bitcoin-cli -regtest createwallet "wallet1"

# Create watch-only wallet
bitcoin-cli -regtest createwallet "watch_only_wallet" true true "" false
```

### 2. Generate Initial Coins

Generate some blocks to get initial coins in regtest mode:

```bash
bitcoin-cli -regtest -rpcwallet=wallet1 generatetoaddress 101 \
  "$(bitcoin-cli -regtest -rpcwallet=wallet1 getnewaddress)"
```

### 3. Set Up Multisig Public Keys

Generate three addresses and get their public keys:

```bash
# First key pair
ADDR1=$(bitcoin-cli -regtest -rpcwallet=wallet1 getnewaddress)
PUBKEY1=$(bitcoin-cli -regtest -rpcwallet=wallet1 getaddressinfo "$ADDR1" | jq -r '.pubkey')

# Second key pair
ADDR2=$(bitcoin-cli -regtest -rpcwallet=wallet1 getnewaddress)
PUBKEY2=$(bitcoin-cli -regtest -rpcwallet=wallet1 getaddressinfo "$ADDR2" | jq -r '.pubkey')

# Third key pair
ADDR3=$(bitcoin-cli -regtest -rpcwallet=wallet1 getnewaddress)
PUBKEY3=$(bitcoin-cli -regtest -rpcwallet=wallet1 getaddressinfo "$ADDR3" | jq -r '.pubkey')
```

### 4. Create and Import the Descriptor

Create a P2SH multisig descriptor and import it to the watch-only wallet:

```bash
# Create descriptor
DESC_NO_CHECKSUM="sh(multi(2,$PUBKEY1,$PUBKEY2,$PUBKEY3))"
DESC_WITH_CHECKSUM=$(bitcoin-cli -regtest getdescriptorinfo "$DESC_NO_CHECKSUM" | jq -r '.descriptor')

# Import to watch-only wallet
bitcoin-cli -regtest -rpcwallet=watch_only_wallet importdescriptors \
  '[{"desc": "'"$DESC_WITH_CHECKSUM"'", "timestamp": "now", "internal": false, "watchonly": true}]'
```

### 5. Fund the P2SH Address

Get the P2SH address and send funds to it:

```bash
# Get P2SH address
P2SH_MULTISIG=$(bitcoin-cli -regtest deriveaddresses "$DESC_WITH_CHECKSUM" | jq -r '.[0]')

# Send 1 BTC to the P2SH address
bitcoin-cli -regtest -rpcwallet=wallet1 sendtoaddress "$P2SH_MULTISIG" 1

# Generate a block to confirm the funding transaction
bitcoin-cli -regtest generatetoaddress 1 \
  "$(bitcoin-cli -regtest -rpcwallet=wallet1 getnewaddress)"
```

### 6. Create the Spending Transaction

Now we'll create a transaction that spends from the P2SH address:

```bash
# Create P2SH destination address
DEST_ADDR=$(bitcoin-cli -regtest -rpcwallet=wallet1 getnewaddress "" "p2sh-segwit")

# Create P2SH change address
CHANGE_ADDR=$(bitcoin-cli -regtest -rpcwallet=wallet1 getnewaddress "" "p2sh-segwit")

# Get the UTXO from the watch-only wallet
UTXO=$(bitcoin-cli -regtest -rpcwallet=watch_only_wallet listunspent | jq -r '.[0]')
TXID=$(echo $UTXO | jq -r '.txid')
VOUT=$(echo $UTXO | jq -r '.vout')

# Create the PSBT
PSBT=$(bitcoin-cli -regtest -rpcwallet=watch_only_wallet walletcreatefundedpsbt \
  "[{\"txid\":\"$TXID\",\"vout\":$VOUT}]" \
  "[{\"$DEST_ADDR\":0.9999}]" \
  0 \
  "{\"includeWatching\":true, \"changeAddress\":\"$CHANGE_ADDR\"}" | jq -r '.psbt')
```

### 7. Sign and Broadcast the Transaction

Finally, sign the PSBT and broadcast the transaction:

```bash
# Sign the PSBT
SIGNED_PSBT=$(bitcoin-cli -regtest -rpcwallet=wallet1 walletprocesspsbt "$PSBT" | jq -r '.psbt')

# Finalize the PSBT
FINAL_TX=$(bitcoin-cli -regtest finalizepsbt "$SIGNED_PSBT" | jq -r '.hex')

# Broadcast the transaction
TXID=$(bitcoin-cli -regtest sendrawtransaction "$FINAL_TX")

# Generate a block to confirm the transaction
bitcoin-cli -regtest generatetoaddress 1 \
  "$(bitcoin-cli -regtest -rpcwallet=wallet1 getnewaddress)"
```

### 8. Verify the Transaction

You can examine the final transaction:

```bash
bitcoin-cli -regtest getrawtransaction "$TXID" true
```

In the transaction output, you should see:
- The input containing a `scriptSig` with signatures and the redeem script
- P2SH outputs (addresses starting with "2" in regtest/testnet)
- The proper multisig script format in the redeem script

## Important Notes

1. The P2SH addresses in regtest/testnet start with "2" (in mainnet they start with "3")
2. Make sure to keep track of the redeem script, as it's required to spend from the P2SH address
3. The watch-only wallet is used to track the P2SH address without holding private keys
4. This example uses a 2-of-3 multisig setup, but P2SH can be used with other script types as well

## Common Issues and Solutions

1. If you get a "Transaction needs a change address" error, make sure to specify a proper change address
2. If signing fails, verify that the wallet contains the necessary private keys
3. For P2SH addresses, always ensure you have the correct redeem script
4. Keep in mind the network fees when calculating output amounts

This guide demonstrates a basic P2SH transaction setup. In production environments, additional security measures and error handling would be necessary.